# Yaklass Progress

## Что это?

Скрипт для скачивания рейтинга учеников со страницы ТОП в ЯКласс и публикации
его в Google Spreadsheets.

Выгрузка сохраняется в БД SQLite. Последующие запуски будут обновлять базу инкрементами.

## Зачем?

Ну, возможно, вы зачем-то захотите собирать статистику по прогрессу всего класса,
где учится ваш ребёнок.

Лично мне это нужно, чтобы устраивать марафоны с вознаграждением. Хочу чтобы
у детей была дополнительная мотивация на закрепление пройденного материала.
Ведь повторение - мать учения, как изввестно.

## Зависимости

Чтобы использовать этот софт, установите [Composer](https://getcomposer.org/).

## Установка

Установить пакет и его зависимости:

```
$ composer onkeltem/yaklass-progress
```

Установите сервер [Selenium](http://selenium-release.storage.googleapis.com/index.html)
и [Chromedriver](https://sites.google.com/a/chromium.org/chromedriver/downloads) либо вручную,
либо запустив прилагающийся скрипт:

```
$ vendor/bin/yaklass-progress-install.sh
```

## Использование

### Список команд

Скрипт выполняет 3 команды:

* `sync` - забрать данные с ЯКласс
* `list` - вывести данные из БД в JSON
* `publish` - опубликовать данные в Google Spreadsheet
* `testload` - генерация случайных тестовых данных.

### Команда `sync`

В корне создайте файл `credentials.json` со следующим содержимым:

```json
{
  "sync": {
    "username": "/* Ваш email на ЯКласс */",
    "password": "/* Ваш пароль */"
  }
}
```

На ЯКласс вам нужно добавить хотя бы одного ребенка, чтобы получить доступ к странице с рейтингом класса.

Запустите сервис **Selenium**, либо вручную, либо прилагающися скриптом:

```
$ vendor/bin/yaklass-progress-start.sh
```

У скрипта есть задержка в 10 секунд, так что просто подождите, когда он запустит сервис в фоне и закончит работать.

Выполните команду `sync`:

```
$ vendor/bin/yaklass-progress sync
```

При первом запуске в корне проекта будет создана и заполнена выгруженными данными база данных
SQLite - `progress.sqlite` .

Последующие запуски `sync` будут обновлять базу *новой информацией* об активности
детишек, если таковая имела место быть (за период с последнего запуска `sync`). 

### Команда `list`

Чтобы посмотреть данные в базе, выполните команду `list`:

```
$ vendor/bin/yaklass-progress list
```

Будет выведен список в формате JSON, который можно уже дальше расковыривать с помощью
шедеврального инстурмента - [jq](https://stedolan.github.io/jq/), например.

Базу SQLite можно просматривать через
[SQLite Database Browser](https://sqlitebrowser.org/) или любой другой аналогичной
тулзы для SQLite 3.

### Команда `publish`

С помощью данной команды данные из БД публикуются в выбранном вами Google Spreadsheet.

Чтобы это осуществить, вам нужно создать **сервисный аккаунт Google Sheets API** и
получить его реквизиты.

Для этого:

* Зайдите в [Google Developer Console](https://console.developers.google.com/)
* Нажмите кнопку `+ ENABLE APIS AND SERVICES` и найдите **Google Sheets API**
* На странице **API** вы должны добавить Credentials типа **Service Account**.

В итоге у вас будет некий email-подобный адрес, плюс будет скачен JSON файл с реквизитами.
Имя файла генеится случаным образом и выглядит примерно так: `some-word-253822-b4260ce85d5c.json`.
Положите его в корень проекта.

Осталось зашарить наш spreadsheet с полученным email-адресом, что мы и делаем.

Добавьте в `config.json` новую секцию:

```json
{
  "publish": {
    "maxVisibleBodyCols": "/* Кол-во показываемых колонок с данными, по-умолчанию: 50 */",
    "sheetTitle": "/* Заголовок конкретного листа, куда публиковать данные */",
    "spreadsheetId": "/* Идентификатор spreadsheet - копируем из строки адреса */",
    "credentials": "/* Назварние того файла с реквизитами, что вы скачали, например: some-word-253822-b4260ce85d5c.json */",
    "locale": "/* Локаль, русские пишут: ru_RU */"
  }
}
```

Отредактируйте значения в соответствии с вашей ситуацией и вы готовы к запуску публикации:

```
$ vendor/bin/yaklass-progress publish
```

Выглядит результат примерно так:

![Spreadsheet](https://i.gyazo.com/e96e34aaa32b2052baa9802a85462b32.png)

Таблица организована по годам, месяцам, неделям и дням.
Кроме того, производится группировка по периодам (неделям), чтобы
отобразить промежуточные итоги.

По-умолчанию, периоды заканчиваются в 7-й день недели (воскресенье),
но вы можете изменить этот день с помощью опции `--checkpoint`. Например:

```
$ vendor/bin/yaklass-progress publish --checkpoint=1
```

сдвинет подведение промежуточных итогов на понедельник.

Таблица сортируется по одному из следующих значений:

* `name` - имя учащегося;
* `total` - кол-во всех набранных баллов;
* `checkpoint` - кол-во баллов, набранных за последний период.

Выбор режима сортировки производится опцией `--sort=FIELD`.

## Структура БД

В базе 2 таблицы: `student` and `activity`.

В таблице `student` хранится краткая информация о детях - UUID с якласса и имена.

В таблице `activity` хранится информация об активности обучающихся.

## Воркфлоу

Поскольку основное назначение скрипта - периодически обновлять базу, нужно
запускать скрипт регулярно, с чем легко справится тот же крон.

Например, запустить `crontab -e` и добавьте 'nb строки:
 
```
0/10 * * * * cd /path/to/project && ./vendor/bin/yaklass-progress-start.sh && ./vendor/bin/yaklass-progress --headless sync >> cron.log 2>&1; ./vendor/bin/yaklass-progress-stop.sh
0/20 * * * * cd /path/to/project && ./vendor/bin/yaklass-progress publish >> cron.log 2>&1
```

Первая строка инструктирует крон каждый час:

* переключаться в директорию проекта,
* запускать сервер Selenium,
* выполнять `sync` с опцией `--headless`,
* останаливать сервер,
* писать вывод в `cron.log` в корне проекта.

Вторая строка публикует данные в Google Spreadsheets.

## TODO

* ~~Добавить `headless` режим для PHP WebDriver.~~
* ~~Добавить возможность получать отчеты (например в CSV)~~

## Контакты

Идеи, предложения? Добро пожаловать в **Issues**. Или пишите, обсудим: aneganov@gmail.com.
