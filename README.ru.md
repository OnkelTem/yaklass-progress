# Yaklass TOP - SQL fetcher

## Description

Скрипт для скачивания рейтинга учеников со страницы ТОП в ЯКласс.

Выгрузка сохраняется в БД SQLite. Последующие запуски будут обновлять базу инкрементами.

## Why

Ну, возможно, вы зачем-то захотите собирать статистику по прогрессу всего класса, 
где учится ваш ребёнок.

Лично мне это нужно, чтобы устраивать марафоны с вознаграждением. Хочу чтобы 
у детей была дополнительная мотивация на закрепление пройденного материала. 
Ведь повторение - мать учения, как изввестно. 

## Prerequisites

Чтобы использовать этот софт, установите [Composer](https://getcomposer.org/).

## Setup

Установить пакет и его зависимости:

```
$ composer init --no-interaction -s dev --repository '{"type": "git", "url": "git@github.com:OnkelTem/yaklass-top-sql.git"}'
$ composer require onkeltem/yaklass-top-sql
```

Установите сервер [Selenium](http://selenium-release.storage.googleapis.com/index.html) 
и [Chromedriver](https://sites.google.com/a/chromium.org/chromedriver/downloads) либо вручную, 
либо запустив прилагающийся скрипт: 

```
$ vendor/bin/yaklass-ts-install.sh
```

## Usage

### List of tasks

Скипт выполняет 3 команды:

* `sync` - забрать данные с ЯКласс 
* `list` - вывести данные из БД в JSON
* `publish` - опубликовать данные в Google Spreadsheet

### Task `sync`

В корне создайте файл `credentials.json` со следующим содержимым:

```json
{
  "sync": {
    "username": "/* Ваш email на ЯКласс */",
    "password": "/* Ваш пароль */"
  }
}
```

На ЯКласс вам нужно настроить хотя бы одного ребенка, чтобы получить доступ к странице с рейтингом класса. 

Запустите сервер Selenium, либо вручную, либо прилагающися скриптом:

```
$ vendor/bin/yaklass-ts-start.sh
```

У скрипта есть задержка в 10 секунд, так что просто подождите, когда он закончит работать.

Запустите команду `sync`:

```
$ vendor/bin/yaklass-ts sync 
```

При первом запуске будет создана БД в корне проекта - `stats.sqlite` и заполнена 
выгруженными данными.

Последующие запуски `sync` будут обновлять базу новой информацией об активности 
детишек, если таковая имела место быть (за период с последнего запуска `sync`).  

### Task `list`

Чтобы посмотреть данные в базе, выполните команду `list`:
 
```
$ vendor/bin/yaklass-ts list
```

Будет выведен список в формате JSON, который можно уже дальше расковыривать с помощью 
гениальной [jq](https://stedolan.github.io/jq/), например.

Поскольку имеем обыкновенную базу SQLite, её можно смотреть через 
[SQLite Database Browser](https://sqlitebrowser.org/) или любой другой аналогичной
тулзы для SQLite 3. 

### Task `publish`

С помощью данной команды данные из БД публикуются в выбранном вами Google Spreadsheet. 

Чтобы это осуществить, вам нужн создать сервисный аккаунт Google Sheets API и 
получить его реквизиты.

Для этого:

* Зайдите в [Google Developer Console](https://console.developers.google.com/)
* Нажмите кнопку `+ ENABLE APIS AND SERVICES` и найдите "Google Sheets API"
* На странице API вы должны добавить Credentials типа "Service Account".

В итоге у вас будет некий email-подобный адрес, плюс будет скачен JSON файл с реквизитами.
Имя файла генеится случаным образом и выглядит примерно так: `some-word-253822-b4260ce85d5c.json`.
Положите его в корень проекта.

Осталось зашарить наш spreadsheet с полученным email-адресом, что мы и делаем.

Добавьте в `config.json` новую секцию:

```json
{
  "publish": {
    "maxVisibleBodyCols": "/* Кол-во показываемых колонок с данными, по-умолчанию: 50 */",
    "sheetTitle": "/* Заголовок конкретного листа, куда публиковать данные */",
    "spreadsheetId": "/* Идентификатор spreadsheet - копируем из строки адреса */",
    "credentials": "/* Назварние того файла с реквизитами, что вы скачали */",
    "locale": "/* Локаль, русские пишут: ru_RU */"
  }
}
```

Отредактируйте значения в соответствии с вашей ситуацией и вы готовы к запуску публикации:

```
$ vendor/bin/yaklass-ts publish
```

Выглядит результат примерно так:

![Spreadsheet](https://i.gyazo.com/e96e34aaa32b2052baa9802a85462b32.png) 

Таблица организована по годам, месяцам, неделям и дням. 
Кроме того, производится группировка по периодам (неделям), чтобы 
отобразить промежуточные итоги. 

По-умолчанию, периоды заканчиваются в 7-й день недели (воскресенье), 
но вы можете изменить этот день с помощью опции `--checkpoint`. Например:

```
$ vendor/bin/yaklass-ts publish --checkpoint=1
```

сдвинет подведение промежуточных итогов на понедельник.

Таблица сортируется по одному из следующих значений:

* `name` - имя учащегося;
* `total` - кол-во всех набранных баллов;
* `checkpoint` - кол-во баллов, набранных за последний период.

Выбор режима сортировки производится опцией `--sort=FIELD`. 


## Database

В базе 2 таблицы: `student` and `activity`.

В таблице `student` хранится краткая информация о детях - UUID с якласса и имена.

В таблице `activity` хранится информация об активности обучающихся.

## Workflow

Поскольку основное назначение скрипта - периодически обновлять базу, нужно
запускать скрипт регулярно, с чем легко справится тот же крон. 

Например, запустить `crontab -e` и добавьте 'nb строки:
  
```
0/10 * * * * cd /path/to/project && ./vendor/bin/yaklass-ts-start.sh && ./vendor/bin/yaklass-ts --headless sync >> cron.log 2>&1; ./vendor/bin/yaklass-ts-stop.sh
0/20 * * * * cd /path/to/project && ./vendor/bin/yaklass-ts publish >> cron.log 2>&1
```

Первая строка инструктирует крон каждый час:
 
* переключаться в директорию проекта,
* запускать сервер Selenium,
* выполнять `sync` с опцией `--headless`, 
* останаливать сервер,
* писать вывод в `cron.log` в корне проекта.

Вторая строка публикует данные в Google Spreadsheets.

## TODO

* ~~Добавить `headless` режим для PHP WebDriver.~~
* ~~Добавить возможность получать отчеты (например в CSV)~~

## Contact

Идеи, предложения? Добро пожаловать в **Issues**. Или пишите, обсудим: aneganov@gmail.com. 
 

